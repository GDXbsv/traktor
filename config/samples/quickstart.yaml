# Traktor Operator - Quick Start Example
# This is the simplest configuration to get started with automatic deployment restarts

---
# Step 1: Create a namespace for testing
apiVersion: v1
kind: Namespace
metadata:
  name: traktor-demo
  labels:
    watch-secrets: "true"  # This label makes the operator watch this namespace

---
# Step 2: Create a test deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
  namespace: traktor-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        env:
        - name: SECRET_VALUE
          valueFrom:
            secretKeyRef:
              name: demo-secret
              key: password

---
# Step 3: Create a test secret with the required label
apiVersion: v1
kind: Secret
metadata:
  name: demo-secret
  namespace: traktor-demo
  labels:
    auto-refresh: "enabled"  # This label makes the operator watch this secret
type: Opaque
stringData:
  password: "initial-password-123"

---
# Step 4: Configure the operator to watch this namespace
apiVersion: traktor.gdxcloud.net/v1alpha1
kind: SecretsRefresh
metadata:
  name: quickstart-watcher
  namespace: default
spec:
  # Watch namespaces with label 'watch-secrets: true'
  namespaceSelector:
    matchLabels:
      watch-secrets: "true"
  
  # Watch secrets with label 'auto-refresh: enabled'
  secretSelector:
    matchLabels:
      auto-refresh: "enabled"
  
  refreshInterval: "5m"

---
# QUICK START GUIDE:
#
# 1. Make sure the operator is deployed:
#    kubectl get pods -n traktor-system
#
# 2. Apply this entire file:
#    kubectl apply -f config/samples/quickstart.yaml
#
# 3. Verify everything is running:
#    kubectl get pods -n traktor-demo
#    kubectl get secretsrefresh quickstart-watcher
#
# 4. Watch the operator logs (in another terminal):
#    kubectl logs -n traktor-system deployment/traktor-controller-manager -f
#
# 5. Update the secret to trigger a restart:
#    kubectl create secret generic demo-secret \
#      --from-literal=password=updated-password-456 \
#      -n traktor-demo \
#      --dry-run=client -o yaml | \
#      kubectl label --local -f - auto-refresh=enabled -o yaml --dry-run=client | \
#      kubectl apply -f -
#
# 6. Watch the deployment restart automatically:
#    kubectl get pods -n traktor-demo -w
#
# 7. Verify the restart annotation was added:
#    kubectl get deployment demo-app -n traktor-demo \
#      -o jsonpath='{.spec.template.metadata.annotations.traktor\.gdxcloud\.net/restartedAt}'
#
# 8. Check the new pods have the updated secret:
#    kubectl exec -n traktor-demo deployment/demo-app -- env | grep SECRET_VALUE
#
# CLEANUP:
#    kubectl delete namespace traktor-demo
#    kubectl delete secretsrefresh quickstart-watcher